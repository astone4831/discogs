<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Discogs Explorer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Discogs Explorer</h1>
    <!-- Release Search -->
    <div class="mb-4">
      <h4>Search by Release ID</h4>
      <div class="input-group mb-2">
        <input type="text" id="releaseId" class="form-control" placeholder="Enter release ID">
        <button onclick="fetchRelease()" class="btn btn-primary">Search</button>
      </div>
    </div>

  <div class="mb-3">
    <label for="artistNameInput" class="form-label">Search Artist by Name</label>
    <input type="text" id="artistNameInput" class="form-control" placeholder="e.g. Taylor Swift" oninput="searchArtistName()">
    <ul id="artistSuggestions" class="list-group mt-1" style="position: absolute; z-index: 999; max-height: 200px; overflow-y: auto; width:100%"></ul>
  </div>
    <!-- Artist Releases Search -->
    <div class="mb-4">
      <h4>Search Releases by Artist ID</h4>
      <div class="input-group mb-2">
        <input type="text" id="artistId" class="form-control" placeholder="Enter artist ID">
        <button onclick="fetchArtist()" class="btn btn-primary">Search</button>
      </div>
    </div>
    <!-- Download CSV for Release -->
    <div class="mb-4">
      <h4>CSV Output for Release</h4>
      <div class="input-group mb-2">
        <input type="text" id="csvReleaseId" class="form-control" placeholder="Enter release ID">
        <button onclick="downloadCSV()" class="btn btn-success">Download CSV</button>
      </div>
    </div>
    <!-- Download Artist Discography -->
    <div class="mb-4">
      <h4>Download Full Artist Discography</h4>
      <div class="input-group mb-2">
        <input type="text" id="artistCsvId" class="form-control" placeholder="Enter artist ID">
        <button onclick="downloadArtistCSV()" class="btn btn-success">Download Artist Discography</button>
      </div>
    </div>
    <!-- Output -->
    <h5>Results</h5>
    <div id="status" class="alert alert-secondary d-flex align-items-center" role="alert" style="display: none;">
  <div id="statusSpinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;"></div>
  <div id="statusText">Loading...</div>
</div>
    <pre id="output" class="bg-white border rounded p-3" style="max-height: 400px; overflow: auto;"></pre>
  </div>
  <!-- Scripts -->
  <script>
    async function fetchRelease() {
      const id = document.getElementById('releaseId').value;
      const res = await fetch(`/release?id=${id}`);
      const data = await res.json();
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    }
    async function fetchArtist() {
      const id = document.getElementById('artistId').value;
      showStatus("Fetching artist releases...", "info", true);
      try {
        const res = await fetch(`/artist_releases?id=${id}`);
        const data = await res.json();
        if (res.ok) {
          document.getElementById('output').textContent = JSON.stringify(data, null, 2);
         showStatus("Artist releases loaded!", "success");
        } else {
          showStatus("Error: " + (data.error || "Unknown error"), "danger");
        }
      } catch (err) {
        showStatus("Unexpected error: " + err.message, "danger");
      }
    }
    function downloadCSV() {
      const id = document.getElementById('csvReleaseId').value;
      if (!id) return;
      window.location.href = `/download_csv?id=${id}`;
    }
    async function downloadArtistCSV() {
      const id = document.getElementById('artistCsvId').value;
      if (!id) {
        showStatus("Please enter an artist ID", "warning");
        return;
      }
      showStatus("Preparing your CSV...", "info", true);
      try {
        const res = await fetch(`/download_artist_csv?id=${id}`);
        if (!res.ok) {
          const error = await res.json();
          showStatus("Error: " + error.error, "danger");
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `artist_${id}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        showStatus("Download started!", "success");
      } catch (err) {
        showStatus("Unexpected error: " + err.message, "danger");
      }
    }

async function searchArtistName() {
  const input = document.getElementById('artistNameInput');
  const suggestions = document.getElementById('artistSuggestions');
  const query = input.value;
  if (query.length < 2) {
    suggestions.innerHTML = '';
    return;
  }
  const res = await fetch(`/search_artist?q=${encodeURIComponent(query)}`);
  const artists = await res.json();
  suggestions.innerHTML = '';
  artists.forEach(artist => {
    const li = document.createElement('li');
    li.className = 'list-group-item list-group-item-action';
    li.textContent = `${artist.name} (ID: ${artist.id})`;
    li.onclick = () => {
      document.getElementById('artistId').value = artist.id;
      suggestions.innerHTML = '';
      input.value = artist.name;
    };
    suggestions.appendChild(li);
  });
}

function showStatus(message, type = "secondary", showSpinner = false) {
  const status = document.getElementById("status");
  const statusText = document.getElementById("statusText");
  const spinner = document.getElementById("statusSpinner");
  status.className = `alert alert-${type} d-flex align-items-center`;
  statusText.innerText = message;
  if (showSpinner) {
    spinner.style.display = "inline-block";
  } else {
    spinner.style.display = "none";
  }
  status.style.display = "flex";
}
function hideStatus() {
  document.getElementById("status").style.display = "none";
}

  </script>
</body>
</html>
